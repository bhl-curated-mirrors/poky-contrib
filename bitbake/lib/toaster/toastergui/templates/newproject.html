{% extends "base.html" %}
{% load projecttags %}
{% load humanize %}

{% block title %} Create a new project - Toaster {% endblock %}

{% block pagecontent %}
<div class="row-fluid">
    <div class="page-header">
          <h1>Create a new project</h1>
        </div>
        <div class="container-fluid">
    {% if alert %}
      <div class="alert alert-error row-fluid" role="alert">{{alert}}</div>
    {% endif %}
        </div>

      <div class="row-fluid">
        <div class="span6">
        <form method="POST">{% csrf_token %}

            <fieldset>
              <label>Project name <span class="muted">(required)</span></label>
              <input type="text" class="input-xlarge" required id="new-project-name" name="projectname">
            </fieldset>

        <input type="hidden" name="ptype" value="build" />

        {% if releases.count > 0 %}
            <fieldset class="release">
            {% if releases.count > 1 %}
              <label class="project-form">
                Release
                <i class="icon-question-sign get-help" title="The version of the build system you want to use"></i>
              </label>
              <select name="projectversion" id="projectversion">
                {% for release in releases %}
                    <option value="{{release.id}}"
                        {%if defaultbranch == release.name %}
                            selected
                        {%endif%}
                     >{{release.description}}</option>
                {% endfor %}
              </select>
                {% for release in releases %}
              <div class="row-fluid helptext" id="description-{{release.id}}" style="display: none">
                <span class="help-block span5">{{release.helptext|safe}}</span>
              </div>
                {% endfor %}
            {% else %}
              <input type="hidden" name="projectversion" value="{{releases.0.id}}"/>
            {% endif %}
            </fieldset>
        {% endif %}
           <dl class="dl-vertical">
            <dt>
                <span class="js-config-var-name js-config-var-managed-name">DL_DIR</span>
                <i class="icon-question-sign get-help" title="Absolute path to the directory used to store downloads required for your builds. By default, Toaster projects share the same downloads directory.<br /><a href='http://www.yoctoproject.org/docs/2.1/ref-manual/ref-manual.html#var-DL_DIR' target='_blank'>Read more in the manual</a>"></i>
            </dt>
            <dd class="lead">
                <span id="dl_dir"{% if dl_dir %}{%else%} class="muted"{%endif%}>{% if dl_dir %}{{dl_dir}}{%else%}Not set{%endif%}</span>
                <i class="icon-pencil" id="change-dl_dir-icon"></i>
                <div id="change-dl_dir-form" style="display:none;">
                    <div class="row-fluid">
                        <span class="help-block span4">To set DL_DIR type the absolute path of the download folder.</span>
                    </div>
                    <div class="input-append" id="validate-dl_dir">
                        <input type="text" class="input-xlarge" id="new-dl_dir" placeholder="Type absolute path of the DL_DIR folder" name="dldir">
                        <button id="apply-change-dl_dir" class="btn" type="button">Save</button>
                        <button id="cancel-change-dl_dir" type="button" class="btn btn-link">Cancel</button>
			</br><span class="help-block error" id="hintError-dl_dir">A valid directory cannot include spaces or any of these characters: . \ ? % * : | " " < ></span>
                    </div>
                </div>
            </dd>
            <dt>
                <span class="js-config-var-name js-config-var-managed-name">SSTATE_DIR</span>
                <i class="icon-question-sign get-help" title="Absolute path to the directory used to store shared state cache files. These files are reused across the builds, which makes the builds faster. By default, Toaster projects share the same cache directory.<br /><a href='http://www.yoctoproject.org/docs/2.1/ref-manual/ref-manual.html#var-SSTATE_DIR' target='_blank'>Read more in the manual</a>"></i>
            </dt>
            <dd class="lead">
                <span id="sstate_dir"{% if sstate_dir %}{%else%} class="muted"{%endif%}>{% if sstate_dir %}{{sstate_dir}}{%else%}Not set{%endif%}</span>
                <i class="icon-pencil" id="change-sstate_dir-icon"></i>
                <div id="change-sstate_dir-form" style="display:none;">
                    <div class="row-fluid">
                        <span class="help-block span4">To set SSTATE_DIR type the absolute path of the download folder.</span>
                    </div>
                    <div class="input-append" id="validate-sstate_dir">
                        <input type="text" class="input-xlarge" id="new-sstate_dir" placeholder="Type absolute path of the SSTATE_DIR folder" name="sstatedir">
                        <span class="error">A valid directory name required</span>
                        <button id="apply-change-sstate_dir" class="btn" type="button">Save</button>
                        <button id="cancel-change-sstate_dir" type="button" class="btn btn-link">Cancel</button>
			</br><p class="help-block error" id="hintError-sstate_dir">A valid directory cannot include spaces or any of these characters: . \ ? % * : | " " < ></span>
                    </div>
                </div>
            </dd>
           </dl>

            <div class="form-actions">
              <input type="submit" id="create-project-button" class="btn btn-primary btn-large" value="Create project"/>
              <span class="help-inline" style="vertical-align:middle;">To create a project, you need to enter a project name</span>
            </div>
        </form>
        </div>

        </div>
    </div>

    <script type="text/javascript">

        $(document).ready(function () {

           // hide the new project button
            $("#new-project-button").hide();
            $('.btn-primary').attr('disabled', 'disabled');

            // enable submit button when all required fields are populated
            $("input#new-project-name").on('input', function() {
                if ($("input#new-project-name").val().length > 0 ){
                    $('.btn-primary').removeAttr('disabled');
                    $(".help-inline").css('visibility','hidden');
                }
                else {
                    $('.btn-primary').attr('disabled', 'disabled');
                    $(".help-inline").css('visibility','visible');
                }
            });

            // show relevant help text for the selected release
            var selected_release = $('select').val();
            $("#description-" + selected_release).show();


            $('select').change(function(){
                var new_release = $('select').val();
                $(".helptext").hide();
                $('#description-' + new_release).fadeIn();
            });

            // change DL_DIR variable
            $('#change-dl_dir-icon').click(function() {
                $('#hintError-dl_dir').hide();
	        // preset the edit value
                var current_val = $("span#dl_dir").text().trim();
                if (current_val == "Not set") {
                    current_val="";
                    $("#apply-change-dl_dir").attr("disabled","disabled");
                }
                $("input#new-dl_dir").val(current_val);

                $('#change-dl_dir-icon, #dl_dir').hide();
                $("#change-dl_dir-form").slideDown();
            });

            $('#cancel-change-dl_dir').click(function(){
                $("#change-dl_dir-form").slideUp(function() {
                    $('#dl_dir, #change-dl_dir-icon').show();
                });
            });

            $("#new-dl_dir").on('input', function(){
	        if ($(this).val().trim().length == 0) {
                    $("#apply-change-dl_dir").attr("disabled","disabled");
                }
                else {
                    var input = $(this);
	            console.log(input.val());
                    var re = /^\/([^ <>\\|":\.%\?\*]+)$/;
	            var invalidDir = re.test(input.val());
		    console.log(invalidDir);
                    if ( invalidDir ) {
                        $('#validate-dl_dir').removeClass('control-group error');
			$("#apply-change-dl_dir").removeAttr("disabled");
                        $('#hintError-dl_dir').hide();
                    } else {
                        $('#validate-dl_dir').addClass('control-group error');
			$("#apply-change-dl_dir").attr("disabled","disabled");
                        $('#hintError-dl_dir').show();
                    }
		    //$("#apply-change-dl_dir").removeAttr("disabled");
                }
            });

            $('#apply-change-dl_dir').click(function(){
                var value = $('#new-dl_dir').val().trim();
                $('#dl_dir').text(value);
                $('#dl_dir').removeClass('muted');
                $("#change-dl_dir-form").slideUp(function () {
                    $('#dl_dir, #change-dl_dir-icon').show();
               });
            });

            // change SSTATE_DIR variable
            $('#change-sstate_dir-icon').click(function() {
                $('#hintError-sstate_dir').hide();
                // preset the edit value
                var current_val = $("span#sstate_dir").text().trim();
                if (current_val == "Not set") {
                    current_val="";
                    $("#apply-change-sstate_dir").attr("disabled","disabled");
                }
                $("input#new-sstate_dir").val(current_val);

                $('#change-sstate_dir-icon, #sstate_dir').hide();
                $("#change-sstate_dir-form").slideDown();
            });

            $('#cancel-change-sstate_dir').click(function(){
                $("#change-sstate_dir-form").slideUp(function() {
                    $('#sstate_dir, #change-sstate_dir-icon').show();
                });
            });

            $("#new-sstate_dir").on('input', function(){
                if ($(this).val().trim().length == 0) {
                    $("#apply-change-sstate_dir").attr("disabled","disabled");
                }
                else {
                    var input = $(this);
                    var re = /^\/([^ <>\\|":\.%\?\*]+)$/;
	            var invalidDir = re.test(input.val());
		    console.log(invalidDir);
                    if ( invalidDir ) {
                        $('#validate-sstate_dir').removeClass('control-group error');
			$("#apply-change-sstate_dir").removeAttr("disabled");
                        $('#hintError-sstate_dir').hide();
                    } else {
                        $('#validate-sstate_dir').addClass('control-group error');
			$("#apply-change-sstate_dir").attr("disabled","disabled");
                        $('#hintError-sstate_dir').show();
                    }
                    //$("#apply-change-sstate_dir").removeAttr("disabled");
                }
            });

            $('#apply-change-sstate_dir').click(function(){
                var value = $('#new-sstate_dir').val().trim();
                $('#sstate_dir').text(value);
                $('#sstate_dir').removeClass('muted');
                $("#change-sstate_dir-form").slideUp(function () {
                    $('#sstate_dir, #change-sstate_dir-icon').show();
               });
            });

        });
    </script>

{% endblock %}
